const File = require('../File');

const ProjectAttr = File.makeSection(function(){
  return `  "${this.data.key}": "${this.data.value}",`;
});

const Description = File.makeSection(function(file){
  let name = file.sections.name.data.value;
  return `  "description": "${name} - generated by sofaStack",`;
});

const Scripts = File.makeSection(function(file){
  let name = file.sections.name.data.value;
  return `  "scripts": {
    "start": "node index.js",
    "start:local": "npm run db-init & DATABASE_URL=postgres://localhost/${name} node index.js",
    "db-init": "pg-init ${name}"
  },`;
});

const Dependencies = File.makeSection(`  "dependencies": {
    "body-parser": "^1.17.1",
    "express": "^4.15.2",
    "fs-misc": "^2.0.0",
    "pg": "^5.1.0",
    "sequelize": "^3.23.3",
    "request": "^2.81.0"
  }`);

const PackageJson = function (projectName, start = 'index.js') {
  const jsonStart = File.makeSection('{');
  const name = new ProjectAttr({key: 'name', value: projectName});
  const version = new ProjectAttr({key: 'version', value: '1.0.0'});
  const license = new ProjectAttr({key: 'license', value: 'MIT'});
  const main = new ProjectAttr({key: 'main', value: start});
  const description = new Description();
  const scripts = new Scripts();
  const dependencies = Dependencies;
  const jsonEnd = File.makeSection('}');

  let file = new File({
    jsonStart,
    name,
    version,
    description,
    main,
    license,
    scripts,
    dependencies,
    jsonEnd,
  });

  const oldToString = file.toString;
  file.toString = function(){
    return oldToString.call(file, '\n');
  };

  return file;
};

module.exports = PackageJson;
